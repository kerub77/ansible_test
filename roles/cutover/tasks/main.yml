---
- name: Ottieni ID del project
  openstack.cloud.project_info:
    auth:
      auth_url: "{{ OS_AUTH_URL }}"
      username: "{{ OS_USERNAME }}"
      password: "{{ OS_PASSWORD }}"
      project_name: "{{ OS_PROJECT_NAME }}"
      user_domain_name: "{{ OS_USER_DOMAIN_NAME }}"
      project_domain_name: "{{ OS_PROJECT_DOMAIN_NAME }}"
    region_name: "{{ OS_REGION_NAME }}"
    interface: internal
    validate_certs: false
    name: "{{ TENANT }}"
  register: PROJECT_ID
  when: "action == 'cutover'"

- name: Set OS_PROJECT_ID
  set_fact:
    openstack_env: "{{ openstack_env | combine({'OS_PROJECT_ID': PROJECT_ID.projects[0].id}) }}"
  when: "action == 'cutover'"

- name: Migration of VM from VMware to OpenStack
  become: yes
  become_user: root
  docker_container:
    name: migratekit_container
    image: "{{ docker_image }}"
    command: >
      cutover
      --availability-zone {{ availability_zone }}
      --vmware-endpoint {{ vmware_endpoint }}
      --vmware-username {{ vmware_username }}
      --vmware-password {{ vmware_password }}
      --vmware-path "{{ vmware_path }}"
      --flavor "{{ flavor }}"
      {% for net in network_mappings %}
      --network-mapping mac={{ net.mac }},network-id={{ net.network_id }},subnet-id={{ net.subnet_id }},ip={{ net.ip }}
      {% endfor %}
    network_mode: "{{ docker_network }}"
    privileged: "{{ docker_privileged }}"
    volumes: "{{ docker_volumes }}"
    env: "{{ openstack_env }}"
    # env_file: "{{ docker_env_file }}"
    detach: false
    auto_remove: true
  register: migration_output

- name: Display Docker container output
  debug:
    var: migration_output.container.Output

